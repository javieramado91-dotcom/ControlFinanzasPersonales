<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Finanzas AI</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        dark: '#0f172a',
                        surface: '#ffffff',
                        background: '#f8fafc'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .bottom-sheet { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        .bottom-sheet.active { transform: translateY(0); }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .toast { animation: fadeInOut 3s forwards; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Estilo tarjeta AI */
        .ai-card {
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
            border: 1px solid #dbeafe;
        }
    </style>
</head>
<body class="bg-background text-slate-800 h-[100dvh] flex flex-col overflow-hidden">

    <!-- 1. ENCABEZADO -->
    <header class="bg-dark text-white pt-safe px-6 pb-8 rounded-b-[2.5rem] shadow-xl z-10 shrink-0 relative overflow-hidden">
        <!-- Efecto de fondo -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse-slow"></div>
        
        <div class="absolute top-6 right-6 text-right z-10">
             <p class="text-[10px] text-blue-300 font-bold uppercase tracking-widest">HOY</p>
             <p class="text-sm font-bold text-white" id="today-display">...</p>
        </div>

        <div class="relative z-10 mt-8">
            <p class="text-blue-200 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                <i class="fas fa-wallet"></i> Saldo Global
            </p>
            <h1 class="text-5xl font-bold tracking-tight" id="header-balance">$0</h1>
        </div>
        
        <!-- Tarjetas Resumen (Mes Seleccionado) -->
        <div class="flex gap-3 mt-8 relative z-10">
            <div class="flex-1 bg-white/5 backdrop-blur-md border border-white/10 p-4 rounded-2xl flex flex-col justify-between h-24">
                <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs mb-2">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div>
                    <p class="text-[10px] text-blue-200 uppercase font-bold opacity-70">Ingresos Mes</p>
                    <p class="font-bold text-lg text-white" id="header-income">$0</p>
                </div>
            </div>
            <div class="flex-1 bg-white/5 backdrop-blur-md border border-white/10 p-4 rounded-2xl flex flex-col justify-between h-24">
                <div class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-xs mb-2">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div>
                    <p class="text-[10px] text-blue-200 uppercase font-bold opacity-70">Gastos Mes</p>
                    <p class="font-bold text-lg text-white" id="header-expense">$0</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. CONTENIDO -->
    <main class="flex-1 overflow-y-auto hide-scroll p-4 pb-32 relative w-full max-w-md mx-auto" id="main-container">
        
        <!-- VISTA: HOME -->
        <section id="view-home" class="view-section space-y-5 animate-fade">
            
            <!-- Navegador Meses -->
            <div class="bg-white rounded-2xl p-2 shadow-sm border border-slate-100 flex items-center justify-between sticky top-0 z-20 backdrop-blur-sm bg-white/90">
                <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-xl hover:bg-slate-100 text-slate-400 flex items-center justify-center active:scale-90 transition">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Visualizando</p>
                    <h3 class="text-lg font-bold text-slate-800 leading-tight" id="month-navigator-label">...</h3>
                </div>
                <button onclick="changeMonth(1)" class="w-10 h-10 rounded-xl hover:bg-slate-100 text-slate-400 flex items-center justify-center active:scale-90 transition">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Botones Acción -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openSheet('ingreso')" class="bg-blue-600 active:bg-blue-700 text-white p-4 rounded-2xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition transform active:scale-95 group">
                    <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center group-hover:scale-110 transition"><i class="fas fa-plus text-sm"></i></div>
                    <span class="font-bold text-sm">Ingreso</span>
                </button>
                <button onclick="openSheet('gasto')" class="bg-slate-800 active:bg-slate-900 text-white p-4 rounded-2xl shadow-lg shadow-slate-300 flex items-center justify-center gap-2 transition transform active:scale-95 group">
                    <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center group-hover:scale-110 transition"><i class="fas fa-minus text-sm"></i></div>
                    <span class="font-bold text-sm">Gasto</span>
                </button>
            </div>

            <!-- Lista Movimientos -->
            <div id="transactions-list" class="space-y-3 pb-4"></div>
            
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <i class="fas fa-receipt text-xl opacity-50"></i>
                </div>
                <p class="text-sm font-medium">Sin movimientos este mes</p>
            </div>
        </section>

        <!-- VISTA: ESTADÍSTICAS INTELIGENTES -->
        <section id="view-stats" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold px-2 flex items-center gap-2">
                <i class="fas fa-brain text-blue-500"></i> Análisis AI
            </h2>

            <!-- TARJETA AI ADVISOR -->
            <div class="ai-card p-5 rounded-3xl shadow-sm relative overflow-hidden">
                <div class="flex items-start gap-4 z-10 relative">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shrink-0 shadow-lg shadow-blue-200">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-1">Diagnóstico Financiero</h3>
                        <div id="ai-insights-container" class="space-y-2">
                            <!-- JS inyecta consejos aquí -->
                            <p class="text-sm text-slate-600 leading-relaxed">Analizando tus patrones de gasto para generar consejos personalizados...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRÁFICO 1: EVOLUCIÓN SEMESTRAL -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 text-center">Evolución Semestral</h3>
                <div class="h-48">
                    <canvas id="chart-history"></canvas>
                </div>
            </div>
            
            <!-- GRÁFICO 2: GASTOS POR CATEGORÍA -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 text-center">Distribución de Gastos (Mes Actual)</h3>
                <div class="h-56 relative flex justify-center">
                    <canvas id="chart-expenses"></canvas>
                    <div id="chart-empty" class="hidden absolute inset-0 flex items-center justify-center text-slate-400 text-xs font-medium bg-white/50 backdrop-blur-sm">
                        Necesitas registrar gastos este mes
                    </div>
                </div>
            </div>
        </section>

        <!-- VISTA: AJUSTES -->
        <section id="view-settings" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold px-2">Configuración</h2>
            
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-50 bg-slate-50/50">
                    <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Categorías</h3>
                </div>
                <div class="p-4 space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-blue-600 uppercase bg-blue-50 px-2 py-1 rounded">Ingresos</span>
                            <button onclick="addCategoryPrompt('ingreso')" class="w-8 h-8 rounded-full hover:bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="settings-cat-ingreso" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-slate-600 uppercase bg-slate-100 px-2 py-1 rounded">Gastos</span>
                            <button onclick="addCategoryPrompt('gasto')" class="w-8 h-8 rounded-full hover:bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="settings-cat-gasto" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="exportData()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-4 border-b border-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-cloud-download-alt"></i></div>
                    <div>
                        <p class="font-bold text-sm text-slate-700">Copia de Seguridad</p>
                        <p class="text-xs text-slate-400">Guardar datos en archivo JSON</p>
                    </div>
                </button>
                <div class="relative">
                    <input type="file" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 z-10" accept=".json">
                    <button class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-4 transition">
                        <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fas fa-cloud-upload-alt"></i></div>
                        <div>
                            <p class="font-bold text-sm text-slate-700">Restaurar Datos</p>
                            <p class="text-xs text-slate-400">Cargar archivo JSON</p>
                        </div>
                    </button>
                </div>
                <button onclick="wipeData()" class="w-full text-left p-4 hover:bg-red-50 flex items-center gap-4 border-t border-slate-50 transition">
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fas fa-trash-alt"></i></div>
                    <p class="font-bold text-sm text-red-600">Eliminar Todo</p>
                </button>
            </div>
            <p class="text-center text-[10px] text-slate-300 pt-2 pb-8 uppercase tracking-widest">Local Secure Storage v3.0</p>
        </section>

    </main>

    <!-- 3. MODAL (BOTTOM SHEET) -->
    <div id="backdrop" onclick="closeSheet()" class="fixed inset-0 bg-slate-900/60 z-40 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm"></div>
    <div id="bottom-sheet" class="bottom-sheet fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[2.5rem] p-6 shadow-2xl max-w-md mx-auto h-[80vh] flex flex-col">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 shrink-0"></div>
        
        <div class="flex justify-between items-center mb-6">
            <h2 id="sheet-title" class="text-2xl font-bold text-slate-800">Nuevo</h2>
            <button onclick="closeSheet()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500"><i class="fas fa-times"></i></button>
        </div>

        <form id="trans-form" onsubmit="submitTransaction(event)" class="flex flex-col flex-1 overflow-y-auto hide-scroll pb-safe">
            <input type="hidden" id="trans-type">
            
            <div class="mb-6">
                <div class="flex items-end gap-2 border-b-2 border-slate-100 focus-within:border-blue-500 transition py-2">
                    <span class="text-2xl font-bold text-slate-400 mb-1">$</span>
                    <input type="number" id="trans-amount" step="0.01" inputmode="decimal" class="w-full text-5xl font-bold text-slate-800 outline-none bg-transparent placeholder-slate-200" placeholder="0" required>
                </div>
            </div>

            <div class="mb-8 flex-1">
                <label class="text-xs font-bold text-slate-400 uppercase mb-3 block tracking-wide">Categoría</label>
                <div id="category-input-area"></div>
            </div>

            <div class="mb-6">
                <div class="bg-slate-50 rounded-2xl px-4 py-3 flex items-center gap-3 border border-slate-100 focus-within:border-blue-300 transition">
                    <i class="fas fa-pen text-slate-400 text-sm"></i>
                    <input type="text" id="trans-note" class="bg-transparent outline-none w-full text-slate-700 font-medium text-sm" placeholder="Nota opcional...">
                </div>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-blue-200 mb-2 active:scale-[0.98] transition">Guardar</button>
        </form>
    </div>

    <!-- 4. BARRA NAVEGACIÓN -->
    <nav class="bg-white/90 backdrop-blur-md border-t border-slate-200/60 fixed bottom-0 w-full pb-safe z-30">
        <div class="flex justify-around items-center h-20 max-w-md mx-auto">
            <button onclick="navTo('home')" id="nav-home" class="nav-btn flex-1 flex flex-col items-center justify-center text-blue-600 gap-1">
                <div class="icon-container w-10 h-8 rounded-xl flex items-center justify-center transition-colors"><i class="fas fa-home text-xl"></i></div>
                <span class="text-[10px] font-bold">Inicio</span>
            </button>
            <button onclick="navTo('stats')" id="nav-stats" class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-400 gap-1 hover:text-slate-600">
                <div class="icon-container w-10 h-8 rounded-xl flex items-center justify-center transition-colors"><i class="fas fa-chart-pie text-xl"></i></div>
                <span class="text-[10px] font-bold">AI Stats</span>
            </button>
            <button onclick="navTo('settings')" id="nav-settings" class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-400 gap-1 hover:text-slate-600">
                <div class="icon-container w-10 h-8 rounded-xl flex items-center justify-center transition-colors"><i class="fas fa-cog text-xl"></i></div>
                <span class="text-[10px] font-bold">Ajustes</span>
            </button>
        </div>
    </nav>

    <!-- NOTIFICACIONES -->
    <div id="toast-container" class="fixed bottom-24 left-0 right-0 flex justify-center pointer-events-none z-50"></div>

    <script>
        // CONFIGURACIÓN INICIAL
        const DEFAULT_CATEGORIES = {
            ingreso: ['Sueldo', 'Negocios', 'Ventas', 'Intereses', 'Regalos', 'Otros'],
            gasto: ['Alimentos', 'Transporte', 'Casa', 'Servicios', 'Salud', 'Suscripciones', 'Ropa', 'Educación', 'Otros']
        };

        let transactions = JSON.parse(localStorage.getItem('fin_transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('fin_categories')) || DEFAULT_CATEGORIES;
        
        // Variables de estado
        let chartExpenses = null;
        let chartHistory = null;
        let selectedCategoryIngreso = ''; 
        let viewDate = new Date(); 

        document.addEventListener('DOMContentLoaded', () => {
            updateDateDisplay();
            refreshUI();
            updateSettingsUI();
        });

        function updateDateDisplay() {
            const now = new Date();
            const str = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('today-display').textContent = str.charAt(0).toUpperCase() + str.slice(1);
        }

        // --- NAVEGACIÓN ---
        function navTo(screen) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-blue-600');
                el.classList.add('text-slate-400');
            });
            
            document.getElementById(`view-${screen}`).classList.remove('hidden');
            document.getElementById(`nav-${screen}`).classList.add('text-blue-600');
            document.getElementById(`nav-${screen}`).classList.remove('text-slate-400');

            if (screen === 'stats') renderAIStats(); // Cargar estadísticas inteligentes
            document.getElementById('main-container').scrollTop = 0;
        }

        function changeMonth(delta) {
            viewDate.setMonth(viewDate.getMonth() + delta);
            refreshUI();
        }

        // --- MOTOR DE INTELIGENCIA (AI ENGINE) ---
        function renderAIStats() {
            // 1. GRAFICO DE BARRAS (Histórico 6 meses)
            renderHistoryChart();
            
            // 2. GRAFICO DE DONA (Mes actual de visualización)
            renderExpenseChart();

            // 3. GENERADOR DE CONSEJOS AI
            const insights = generateInsights();
            const container = document.getElementById('ai-insights-container');
            
            if (insights.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-500 italic">Registra más movimientos para obtener un análisis detallado.</p>';
            } else {
                container.innerHTML = insights.map(i => `
                    <div class="flex gap-3 items-start p-3 bg-white rounded-xl border-l-4 ${i.borderClass} shadow-sm">
                        <i class="fas ${i.icon} ${i.textClass} mt-1"></i>
                        <p class="text-xs text-slate-600 font-medium leading-relaxed">${i.text}</p>
                    </div>
                `).join('');
            }
        }

        function generateInsights() {
            const tips = [];
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const lastMonthKey = now.getMonth() === 0 ? `${now.getFullYear()-1}-11` : `${now.getFullYear()}-${now.getMonth()-1}`;

            // Helper para filtrar
            const getMonthData = (y, m) => transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === y && d.getMonth() === m;
            });

            const currData = getMonthData(now.getFullYear(), now.getMonth());
            const lastData = getMonthData(now.getMonth() === 0 ? now.getFullYear()-1 : now.getFullYear(), now.getMonth() === 0 ? 11 : now.getMonth()-1);

            const currInc = currData.filter(t=>t.type==='ingreso').reduce((a,b)=>a+b.amount,0);
            const currExp = currData.filter(t=>t.type==='gasto').reduce((a,b)=>a+b.amount,0);
            const lastExp = lastData.filter(t=>t.type==='gasto').reduce((a,b)=>a+b.amount,0);

            // 1. Análisis de Ahorro
            if (currInc > 0) {
                const savingsRate = ((currInc - currExp) / currInc) * 100;
                if (savingsRate > 20) {
                    tips.push({ text: `¡Excelente! Estás ahorrando el ${savingsRate.toFixed(0)}% de tus ingresos este mes.`, icon: 'fa-piggy-bank', textClass: 'text-green-500', borderClass: 'border-green-500' });
                } else if (savingsRate < 0) {
                    tips.push({ text: `Cuidado. Estás gastando más de lo que ingresas. Revisa tus gastos hormiga.`, icon: 'fa-exclamation-triangle', textClass: 'text-red-500', borderClass: 'border-red-500' });
                }
            }

            // 2. Comparación con mes anterior
            if (lastExp > 0 && currExp > 0) {
                const diff = currExp - lastExp;
                const percent = ((diff / lastExp) * 100).toFixed(0);
                if (diff > 0 && percent > 15) {
                    tips.push({ text: `Tus gastos han subido un ${percent}% respecto al mes anterior.`, icon: 'fa-chart-line', textClass: 'text-orange-500', borderClass: 'border-orange-500' });
                } else if (diff < 0) {
                    tips.push({ text: `¡Bien hecho! Has reducido tus gastos un ${Math.abs(percent)}% comparado con el mes pasado.`, icon: 'fa-thumbs-up', textClass: 'text-blue-500', borderClass: 'border-blue-500' });
                }
            }

            // 3. Categoría más costosa
            if (currExp > 0) {
                const catTotals = {};
                currData.filter(t=>t.type==='gasto').forEach(t => catTotals[t.category] = (catTotals[t.category]||0) + t.amount);
                const maxCat = Object.keys(catTotals).reduce((a, b) => catTotals[a] > catTotals[b] ? a : b);
                const maxAmount = catTotals[maxCat];
                const percentage = ((maxAmount / currExp) * 100).toFixed(0);
                
                tips.push({ text: `"${maxCat}" es tu mayor gasto (${percentage}% del total). ¿Es posible optimizarlo?`, icon: 'fa-wallet', textClass: 'text-slate-500', borderClass: 'border-slate-400' });
            }

            return tips;
        }

        // --- GRAFICOS ---
        function renderHistoryChart() {
            const ctx = document.getElementById('chart-history').getContext('2d');
            
            // Generar datos ultimos 6 meses
            const labels = [];
            const dataInc = [];
            const dataExp = [];
            
            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const label = d.toLocaleDateString('es-ES', {month:'short'});
                labels.push(label);
                
                const monthTrans = transactions.filter(t => {
                    const td = new Date(t.date);
                    return td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear();
                });
                
                dataInc.push(monthTrans.filter(t=>t.type==='ingreso').reduce((a,b)=>a+b.amount,0));
                dataExp.push(monthTrans.filter(t=>t.type==='gasto').reduce((a,b)=>a+b.amount,0));
            }

            if (chartHistory) chartHistory.destroy();

            chartHistory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Ingresos', data: dataInc, backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'Gastos', data: dataExp, backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderExpenseChart() {
            const ctx = document.getElementById('chart-expenses').getContext('2d');
            const viewMonth = viewDate.getMonth();
            const viewYear = viewDate.getFullYear();
            
            const filtered = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === viewMonth && d.getFullYear() === viewYear && t.type === 'gasto';
            });

            const totals = {};
            filtered.forEach(t => totals[t.category] = (totals[t.category] || 0) + t.amount);
            const data = Object.values(totals);
            
            document.getElementById('chart-empty').classList.toggle('hidden', data.length > 0);

            if (chartExpenses) chartExpenses.destroy();

            if (data.length > 0) {
                chartExpenses = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(totals),
                        datasets: [{
                            data: data,
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        cutout: '70%'
                    }
                });
            }
        }

        // --- LÓGICA PRINCIPAL UI ---
        function refreshUI() {
            // Balance Global
            const total = transactions.reduce((acc, t) => t.type === 'ingreso' ? acc + t.amount : acc - t.amount, 0);
            document.getElementById('header-balance').innerText = formatMoney(total);

            // Label Mes
            const monthLabel = viewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('month-navigator-label').textContent = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            // Filtrar mes seleccionado
            const monthTrans = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear();
            });

            // Resumen Mes
            const inc = monthTrans.filter(t => t.type === 'ingreso').reduce((a, b) => a + b.amount, 0);
            const exp = monthTrans.filter(t => t.type === 'gasto').reduce((a, b) => a + b.amount, 0);
            document.getElementById('header-income').innerText = formatMoney(inc);
            document.getElementById('header-expense').innerText = formatMoney(exp);

            // Lista
            renderTransactionList(monthTrans);
        }

        function renderTransactionList(listData) {
            const container = document.getElementById('transactions-list');
            container.innerHTML = '';
            
            if (listData.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            const grouped = {};
            listData.forEach(t => {
                const d = new Date(t.date).toLocaleDateString('es-ES', { weekday:'short', day:'numeric', month:'short'});
                if(!grouped[d]) grouped[d] = [];
                grouped[d].push(t);
            });

            for (const [date, items] of Object.entries(grouped)) {
                const header = document.createElement('h4');
                header.className = "text-[10px] font-bold text-slate-400 uppercase ml-2 mb-2 mt-4";
                header.innerText = date;
                container.appendChild(header);

                items.forEach(t => {
                    const isInc = t.type === 'ingreso';
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-2xl shadow-sm border border-slate-50 mb-2 flex justify-between items-center";
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-full ${isInc ? 'bg-blue-50 text-blue-600' : 'bg-red-50 text-red-500'} flex items-center justify-center font-bold text-sm shrink-0">
                                ${t.category.charAt(0)}
                            </div>
                            <div class="min-w-0">
                                <p class="font-bold text-slate-700 text-sm truncate">${t.category}</p>
                                <p class="text-xs text-slate-400 truncate">${t.note || t.type}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <span class="font-bold ${isInc ? 'text-blue-600' : 'text-slate-800'}">${isInc?'+':'-'}${formatMoney(t.amount)}</span>
                            <button onclick="deleteTrans(${t.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }
        }

        // --- GESTIÓN DATOS ---
        function submitTransaction(e) {
            e.preventDefault();
            const type = document.getElementById('trans-type').value;
            const amount = parseFloat(document.getElementById('trans-amount').value);
            const note = document.getElementById('trans-note').value;
            
            let cat = type === 'ingreso' ? selectedCategoryIngreso : document.getElementById('gasto-select').value;
            
            if (!amount || amount <= 0) return showToast("⚠️ Ingresa un monto");
            if (!cat) return showToast("⚠️ Selecciona categoría");

            transactions.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                type, amount, category: cat, note
            });
            
            saveData();
            viewDate = new Date(); // Volver a hoy
            refreshUI();
            closeSheet();
            showToast("✅ Guardado");
        }

        function deleteTrans(id) {
            if(confirm("¿Eliminar?")) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                refreshUI();
            }
        }

        // --- MODALES Y CONFIGURACIÓN ---
        function openSheet(type) {
            document.getElementById('trans-form').reset();
            document.getElementById('trans-type').value = type;
            const title = document.getElementById('sheet-title');
            const btn = document.getElementById('btn-submit');
            const area = document.getElementById('category-input-area');

            document.getElementById('backdrop').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('backdrop').classList.remove('opacity-0'); 
                document.getElementById('bottom-sheet').classList.add('active'); 
            }, 10);

            if (type === 'ingreso') {
                title.innerText = "Nuevo Ingreso";
                title.className = "text-2xl font-bold text-blue-600";
                btn.className = "w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-blue-200 mb-2 active:scale-[0.98] transition bg-blue-600";
                
                area.innerHTML = `<div class="grid grid-cols-3 gap-2" id="ingreso-grid"></div>`;
                const grid = document.getElementById('ingreso-grid');
                categories.ingreso.forEach(c => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = "p-2 rounded-xl border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50";
                    b.innerText = c;
                    b.onclick = () => {
                        grid.querySelectorAll('button').forEach(bt => bt.className = "p-2 rounded-xl border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50");
                        b.className = "p-2 rounded-xl border border-blue-500 bg-blue-50 text-blue-600 text-xs font-bold";
                        selectedCategoryIngreso = c;
                    };
                    grid.appendChild(b);
                });
            } else {
                title.innerText = "Nuevo Gasto";
                title.className = "text-2xl font-bold text-slate-800";
                btn.className = "w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-slate-300 mb-2 active:scale-[0.98] transition bg-slate-800";
                area.innerHTML = `
                    <div class="relative">
                        <select id="gasto-select" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-slate-700 appearance-none outline-none">
                            <option value="" disabled selected>Selecciona...</option>
                            ${categories.gasto.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                `;
            }
            setTimeout(() => document.getElementById('trans-amount').focus(), 300);
        }

        function closeSheet() {
            document.getElementById('bottom-sheet').classList.remove('active');
            document.getElementById('backdrop').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('backdrop').classList.add('hidden');
                document.getElementById('trans-amount').blur();
            }, 300);
        }

        // --- AJUSTES Y CATEGORÍAS ---
        function updateSettingsUI() {
            const renderCats = (type, containerId, color) => {
                const cont = document.getElementById(containerId);
                cont.innerHTML = '';
                categories[type].forEach((c, idx) => {
                    cont.innerHTML += `
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-xs font-bold text-slate-600 shadow-sm">
                            ${c}
                            <button onclick="removeCategory('${type}', ${idx})" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
            };
            renderCats('ingreso', 'settings-cat-ingreso');
            renderCats('gasto', 'settings-cat-gasto');
        }

        function addCategoryPrompt(type) {
            const name = prompt("Nombre categoría:");
            if(name) { categories[type].push(name); saveData(); updateSettingsUI(); }
        }
        function removeCategory(type, idx) {
            if(confirm("¿Borrar?")) { categories[type].splice(idx,1); saveData(); updateSettingsUI(); }
        }

        // --- TOOLS ---
        function saveData() {
            localStorage.setItem('fin_transactions', JSON.stringify(transactions));
            localStorage.setItem('fin_categories', JSON.stringify(categories));
        }
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(amount);
        }
        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const e = document.createElement('div');
            e.className = "toast bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-xs font-bold mb-3 flex items-center gap-2";
            e.innerHTML = msg;
            c.appendChild(e);
            setTimeout(() => e.remove(), 3500);
        }
        function exportData() {
            const d = JSON.stringify({t:transactions, c:categories});
            const b = new Blob([d], {type:"application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importData(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.t && d.c && confirm("¿Sobrescribir datos?")) {
                        transactions = d.t; categories = d.c; saveData(); location.reload();
                    }
                } catch(e) { alert("Error archivo"); }
            };
            r.readAsText(f);
        }
        function wipeData() {
            if(confirm("¿BORRAR TODO?")) { localStorage.clear(); location.reload(); }
        }
    </script>
</body>
</html>
